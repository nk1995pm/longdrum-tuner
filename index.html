<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Drum Tuner - Realtime</title>
    <style>
        :root { --primary: #d35400; --secondary: #2c3e50; --bg: #fdf2e9; }
        body { font-family: 'Sarabun', sans-serif; background: #eee; padding: 20px; display: flex; justify-content: center; }
        .app-container { background: white; width: 100%; max-width: 400px; padding: 25px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .option-group { margin-bottom: 15px; text-align: left; }
        .chips { display: flex; gap: 10px; }
        .chip { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 12px; cursor: pointer; background: white; font-weight: bold; }
        .chip.active { border-color: var(--primary); background: var(--primary); color: white; }
        .tuner-display { background: #222; color: #00ff00; border-radius: 20px; padding: 30px 10px; margin: 20px 0; }
        .hz-text { font-size: 48px; font-family: monospace; }
        .needle { width: 3px; height: 70px; background: red; margin: 0 auto; transform-origin: bottom center; transition: 0.1s; }
        .btn-main { width: 100%; padding: 18px; border-radius: 50px; border: none; background: var(--secondary); color: white; font-size: 18px; font-weight: bold; cursor: pointer; }
        .advice-card { background: var(--bg); border-radius: 15px; padding: 15px; text-align: left; border-left: 5px solid var(--primary); margin-top: 15px; min-height: 80px; }
    </style>
</head>
<body>

<div class="app-container">
    <h2>ü•Å ‡∏à‡∏π‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</h2>

    <div class="option-group">
        <div class="chips">
            <button class="chip active" onclick="setDrum('small', this)">‡πÉ‡∏ö‡πÄ‡∏•‡πá‡∏Å</button>
            <button class="chip" onclick="setDrum('large', this)">‡πÉ‡∏ö‡πÉ‡∏´‡∏ç‡πà</button>
        </div>
    </div>

    <div class="tuner-display">
        <div class="needle" id="needle"></div>
        <div class="hz-text" id="current-hz">0.0</div>
        <div style="color: #666;">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: <span id="target-hz">250</span> Hz</div>
    </div>

    <div class="advice-card">
        <b id="status-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå</b>
        <div id="advice-content">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
    </div>

    <button id="start-btn" class="btn-main" onclick="toggleAudio()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á</button>
</div>

<script>
    let audioContext = null;
    let analyser = null;
    let dataArray = null;
    let isListening = false;
    let targetHz = 250;

    const config = {
        targets: { small: 250, large: 180 }
    };

    function setDrum(val, el) {
        targetHz = config.targets[val];
        document.getElementById('target-hz').innerText = targetHz;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    async function toggleAudio() {
        if (isListening) {
            isListening = false;
            document.getElementById('start-btn').innerText = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á";
            return;
        }

        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(stream);
            
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            source.connect(analyser);
            
            dataArray = new Float32Array(analyser.fftSize);
            isListening = true;
            document.getElementById('start-btn').innerText = "‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
            updatePitch();
        } catch (err) {
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: " + err);
        }
    }

    function updatePitch() {
        if (!isListening) return;

        analyser.getFloatTimeDomainData(dataArray);
        const pitch = autoCorrelate(dataArray, audioContext.sampleRate);

        if (pitch !== -1) {
            document.getElementById('current-hz').innerText = pitch.toFixed(1);
            updateUI(pitch);
        }
        
        requestAnimationFrame(updatePitch);
    }

    // ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Autocorrelation)
    function autoCorrelate(buffer, sampleRate) {
        let SIZE = buffer.length;
        let rms = 0;
        for (let i = 0; i < SIZE; i++) rms += buffer[i] * buffer[i];
        rms = Math.sqrt(rms / SIZE);
        if (rms < 0.01) return -1; // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

        let r1 = 0, r2 = SIZE - 1, thres = 0.2;
        for (let i = 0; i < SIZE / 2; i++) if (Math.abs(buffer[i]) < thres) { r1 = i; break; }
        for (let i = 1; i < SIZE / 2; i++) if (Math.abs(buffer[SIZE - i]) < thres) { r2 = SIZE - i; break; }
        
        buffer = buffer.slice(r1, r2);
        SIZE = buffer.length;

        let c = new Float32Array(SIZE);
        for (let i = 0; i < SIZE; i++)
            for (let j = 0; j < SIZE - i; j++)
                c[i] = c[i] + buffer[j] * buffer[j + i];

        let d = 0; while (c[d] > c[d + 1]) d++;
        let maxval = -1, maxpos = -1;
        for (let i = d; i < SIZE; i++) {
            if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
        }
        return sampleRate / maxpos;
    }

    function updateUI(pitch) {
        const diff = pitch - targetHz;
        const needle = document.getElementById('needle');
        const status = document.getElementById('status-label');
        const advice = document.getElementById('advice-content');

        needle.style.transform = `rotate(${Math.max(-45, Math.min(45, diff * 2))}deg)`;

        if (Math.abs(diff) < 3) {
            status.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡πÅ‡∏•‡πâ‡∏ß!";
            advice.innerText = "‡∏°‡∏ß‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß";
        } else if (diff > 0) {
            status.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏π‡∏á‡πÑ‡∏õ";
            advice.innerText = "‡∏Ñ‡∏ß‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ñ‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏ö‡∏Å‡∏•‡∏≠‡∏á";
        } else {
            status.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥‡πÑ‡∏õ";
            advice.innerText = "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏ß‡∏•‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ñ‡πà‡∏ß‡∏á";
        }
    }
</script>

</body>
</html> 